---
title: "linktree vignette"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{linktree vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE, 
  dpi=400,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%",
  fig.align = "center"
)
```

# linktree

The goal of `linktree` is to estimate the transmission assortativity coefficient. More information [here](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0313037).

## Installation

```{r}
library(remotes)
remotes::install_github("CyGei/linktree")
library(linktree)
```

## Understanding the transmission assortativity coefficient

The `linktree` framework uses transmission chain data to estimate *group transmission assortativity*, which **quantifies the tendency of individuals to transmit within their own group relative to other groups**.

It is defined as the relative increase, or decrease, in the probability of within-group transmission compared to what would be expected under random transmission. Random transmission expectations are calculated based on the group's relative size, defined as proportion of the total susceptible population that belongs to the group.

The metric characterises transmission patterns, reflecting both contact patterns and group-specific differences in susceptibility or infectiousness.

### Gamma

$\gamma$ ranges from $0$ to $\infty$, where:

-   $\gamma_A = 1$ represents **homogeneous** (random) transmission:\
    Individuals in group *A* are equally likely to transmit in *A* as in other groups.

-   $\gamma_A$ \>1 indicates **assortative** transmission:\
    Individuals in group *A* are more likely to transmit in *A* than in other groups.

-   $\gamma_A < 1$ indicates disassortative transmission:\
    Individuals in group *A* are less likely to transmit in *A* than in other groups.

For example, if $\gamma_A = 2$, individuals in group *A* are **twice** more likely to transmit within group *A* compared to other groups. Conversely, if $\gamma_A = 1/2$, individuals in group *A* are **half** as likely to transmit within group *A* compared to other groups.

### Delta

To simplify interpretation, we introduce a **rescaled** parameter $\delta$, ranging between $-1$ (fully disassortative) and $1$ (fully assortative), with 0 indicating homogeneous patterns.

We can visualise the relationship between $\gamma$ and $\delta$:

```{r, fig.width=8, fig.height=6}
delta <- seq(-1, 1, 0.1)
gamma <- delta2gamma(delta)
plot(gamma, delta, type = "l")
points(1, 0, col = "red", pch = 16)  # Homogeneous
```

### Estimation

`get_gamma` and `get_delta` estimate $\gamma$ and $\delta$ from a transmission tree. It requires the following inputs:

-   `from`: a vector of infector's group (*e.g.* age group, sex, vaccination status, etc.).

-   `to`: a vector of infectee's group.

-   `f`: a named vector of the groups' sizes or relative sizes (*i.e.* proportion of the population in each group).

## Example

### Data

We can simulate an outbreak with multiple groups using the [`o2groups`](https://github.com/CyGei/o2groups) package and then use `linktree` to estimate the assortativity coefficients from the transmission tree.

```{r}
remotes::install_github("CyGei/o2groups")
library(o2groups)
true_gamma <- c(2, 0.8) # assortativity coefficients

set.seed(123)
sim <- simulate_groups(
  duration = 100,
  group_n = 2,
  size = c(100, 400),
  name = c("HCW", "patient"),
  gamma = true_gamma,
  intro_n = c(1, 3),
  r0 = c(1.7, 2),
  generation_time = c(0, 0.1, 0.2, 0.4, 0.2, 0.1, 0),
  incubation_period = sample(1:14, 1000, replace = TRUE)
)
head(sim)
```

### Visualise the transmission tree

```{r, message=FALSE}
remotes::install_github('reconhub/epicontacts@timeline')
library(dplyr)
library(epicontacts)
library(visNetwork)

x <- epicontacts::make_epicontacts(
  linelist = dplyr::select(sim, c(group, id, date_infection, date_onset)),
  contacts = dplyr::select(sim, c(source, id, source_group, group)),
  id = "id",
  from = "source",
  to = "id",
  directed = TRUE
)

plot(x,
    method = "visNetwork",
    x_axis = "date_infection",
    label = FALSE,
    node_color = "group", 
    node_shape = "group",
    shapes = c(patient = "bed", HCW = "user-md"),
    edge_color = "source_group",
    edge_width = 1,
    node_size = 20,
    col_pal = epicontacts::spectral,
    edge_col_pal = epicontacts::spectral
  ) %>%
  visNetwork::visEdges(shadow = TRUE,
                       arrows = list(to = list(enabled = TRUE, scaleFactor = 0.1))) 
```

### Estimate the transmission assortativity coefficient


Our published [paper](https://journals.plos.org/plosone/article?id=10.1371/journal.pone.0313037) provides guidelines as to when and under which circumstances we can reliably infer group transmission assortativity. Notably, we should analyse transmission chains up to the group's epidemic peak to avoid the saturation effect, and we should have at least ~30 cases in the group.

```{r, fig.width=8, fig.height=6, message=FALSE}
est_delta <- get_delta(
  from = sim$source_group,
  to = sim$group,
  f = c("HCW" = 100, "patient" = 400),
)
true_delta <- gamma2delta(true_gamma)

plot(est_delta, main = "Estimated vs True assortativity coefficients")
abline(h = true_delta, col = c("#d53e4f", "#3288bd"), lty = 2)
legend("topright", legend = c("HCW (truth)", "patient (truth)"), fill = c("#d53e4f", "#3288bd"), bty = "n")
```




